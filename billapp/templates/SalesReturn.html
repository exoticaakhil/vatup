

{% extends 'base.html' %}
{% load static %}
{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css" rel="stylesheet" />

<style>
    input {
        background-color: black;
        color: white;
    }

    .input_border {
        border: 1px solid #68020F;
    }
    .form-control{
        border:1px solid #68020F;
    }
    a {
        text-decoration: none;
    }

    .nav {
        background-color: rgba(241, 210, 210, 0.5);
    }

    .nav-link {
        font-size: 15px;
        margin-right: 19px;
        color: rgb(130, 127, 127);
        margin-left: -3%;
        font-weight: bold;
    }

    .tab-pan {
        background-color: rgb(130, 127, 127);
    }

    .button_border {
        border: 1px solid #68020F;
        color: #68020F;
    }

    .button_border:hover {
        background-color: #68020F;
        color: white;
    }
    .table{
        border:1px solid #000;
    }

    thead {
            background-color: #68020F; 
            color: #fff; 
        }

    .tab-pane{
        display: none;
    }

    .tabContainer .tab-pane{
        display: none;
    }

    .tabContainer .nav .nav-item button {
    background-color: transparent;
    color: #000; /* Change the color to your desired color */
    border: none;
    cursor: pointer;
    }

    .tabContainer .nav .nav-item button.active {
    background-color: #68020F;
    color: #fff;
    }

    .tabContainer2 .nav .nav-item button {
    background-color: transparent;
    color: #000; /* Change the color to your desired color */
    border: none;
    cursor: pointer;
    }

    .tabContainer2 .nav .nav-item button.active {
    background-color: #68020F;
    color: #fff;
    }



    .myDropDown{
        flex: 1;
      
    }
    .select2-container--default .select2-selection--single {

        height: 39px;
        border: 1px solid #68020F;  /* Add border style */
        background-color: white;
        color: white;  /* Add text color */
        display: flex; /* Use Flexbox */
        align-items: center; /* Align vertically in the center */
        padding: 0 2px;
        
    }
  
    .select2-container--default .select2-search--dropdown .select2-search__field {
    color:black;
    background-color: white;
    }

    .small-input{
        width: 90px;
        margin-left: 8px;
    }
    

    input[type="radio"]:checked{
    accent-color: #68020F;
  }

  .input_border{
    border: 1px solid #68020F;
  }

  .tb {
    color: black;
  }

  ::-webkit-scrollbar {
    display: none
  }
  select option:hover{
    background-color: black;
  }

  input[type="radio"]:checked{
    accent-color: #68020F;
  }

  .input_border{
    border: 1px solid #68020F;
  }
  #toPayRadio {
        accent-color: red;
    }

    #toReceiveRadio {
        accent-color: green;
    }
    .card-body1{
        box-shadow: 2px 2px 10px 3px rgba(0, 0, 0, 0.397);
        border-radius: 1vh;
    }


</style>
<div class="body-wrapper">
    <div class="container">
        <br><br><br>
       <div class="p-3 mb-5 card-body1" style=" border-radius: 2.5vh; background-color: white;">
            <div class="card-body">
                <h1 class="modal-title fs-5 p-1" id="exampleModalLabel"
                                    style="color: #68020F; font-weight: 900;">ADD CREDITNOTE</h1>
                <form class="row g-3 " method="post" action="{% url 'saveCreditnote' %}" enctype="multipart/form-data" id="pbillForm">
                    {% csrf_token %}
                    <div class="form-group row g-3">
                        <div class="col-md-6" style="display: flex; margin-top: 10px; margin-left: 10px;">
                            <input type="text" name="partystatus" id="partystatus" hidden>
                            <div class="form-check">  
                                <label style="user-select: none;" class="fs-4 tb" for="partyRadio">
                                    Party ON
                                </label>
                                <input class="me-1" type="radio" name="partyStatusGroup" id="partyonRadio">
                            </div>
                            <div class="form-check" style="margin-left: 30px;">
                                
                                <label style="user-select: none;" class="fs-4 tb" for="partyRadio">
                                    Party OFF
                                </label>
                                <input class="me-1" type="radio" name="partyStatusGroup" id="partyoffRadio">
                            </div>
                        </div><br>  
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6 partyon" hidden>
                                    <label for="" class="form-label">Party Name</label>
                                    <div style="display: flex;">
                                        <div class="myDropDown">
                                            <select id="party_details" class="form-control party_details" name="party_details" style="width: 100%;">      
                                                <option value="" selected disabled>Select a party name</option>
                                                {% for party in parties %}
                                                <option value="{{ party.id }} {{ party.contact }} {{ party.salesinvoice.invoice_no }}
                                                {{ party.salesinvoice.date|date:'Y-m-d' }}
                                                {{party.openingbalance}} {{ party.salesinvoice.address }} {{ party.payment }}{{party.address}}" >
                                                {{ party.party_name }}</option>
                                                {% endfor %}            
                                            </select>
                                        </div>
                                        <div class="btn-group" role="group" aria-label="Third group" style="margin-left: 5px;">
                                            <button type="button" class="btn button_border" id="unitmodalBtn" data-bs-toggle="modal"
                                                data-bs-target="#unitModal" data-bs-whatever="@mdo"
                                                >
                                                <span class="fa fa-plus"></span>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="balance"></div>
                                </div>
                                <div class="col-md-6 partyon" hidden>
                                    <label for="" class="form-label">Phone Number</label>
                                    <input type="text" class="form-control" id="party_phone" name="party_phone">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label for="validationDefaultUsername" class="form-label">Return Date</label>
                                    <input type="date" class="form-control" id="returndate" name="returndate" value="{% now 'Y-m-d' %}">
                                </div>
                                
                                    <div class="col-md-4">
                                        <label for="validationDefaultUsername" class="form-label">Reference:</label>
                                        <input type="text" class="form-control" id="refnum" name="refnum" value="{{reference_number}}" readonly>
                                    </div>
                                
                                <div class="col-md-4 partyon" hidden>
                                    <label for="validationDefaultUsername" class="form-label">Payment</label>
                                    <input type="text" class="form-control" id="paymethod" name="paymethod">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 partyon" hidden>
                            <label for="" class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="row mt-3 partyon" id="salesinvoiceid" hidden>
                        <div class="col-md-4">
                            <label for="validationDefaultUsername" class="form-label">Invoice Number</label>

                                <select class="form-control" name="invoiceno" id="invoiceno" style="color: black;">
                                    <option value="" selected hidden>Select</option>
                                    {% for bill_number in invoiceno %}
                                    <option value="{{ bill_number }}">{{ bill_number }}</option>
                                    {% endfor %}
                                </select>

                            
                        </div>
                     
                        <div class="col-md-4">
                            <label for="validationDefaultUsername" class="form-label">Invoice Date</label>
                            <input type="date" class="form-control" id="invoicedate" name="invoicedate">
                        </div>
                    </div>
                    <div class="invoicemain" id="items">
                        <div class="row clearfix">
                            <div class="col-md-12 table-responsive-md mt-3">
                                <table class="table table-bordered table-hover  mt-3" id="tab_logic" >
                                    <thead>
                                        <tr style="color: rgb(250, 246, 246);">
                                            <th class="text-center">#</th>
                                            <th class="text-center">PRODUCT</th>
                                            <th class="text-center">HSN</th>
                                            <th class="text-center">QTY</th>
                                            <th class="text-center">PRICE</th>
                                            <th class="text-center">VAT (%)</th>
                                            <th class="text-center">DISCOUNT</th>
                                            <th class="text-center">TOTAL</th>
                                            <th class="text-center">FIELD</th>
                                        </tr>
                                    </thead>
                                   
                                    
                                    
                                    <tbody id="items-table-body">
                                     
                                        
                                        <tr id='addr01'>
                                            <td class="nnum" style="text-align: center; color: black; width:2%">1</td>
    
                                            <td style="width:18%">
                                                <div class="d-flex">
                                                    <!-- 1111 -->
                                                    <select name='product[]' id="product" class="form-control  product select2 itemselect"  onchange="changeprd1()" style="color: black; background-color: white; ">
                                                        <option selected disabled>Select Item</option>
                                                         {% for item in items %}
                                                            {% if i.cid_id == cmp.cid %}
                                                                <option style="border-color: #FFADB0;" value="{{ item.id }}" >{{ item.itm_name  }} </option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select> &nbsp;&nbsp;&nbsp;
                                                    <button type="button" class="btn button_border" id="itmodalBtn" data-bs-toggle="modal"
                                                    data-bs-target="#itModal" data-bs-whatever="@mdo">
                                                    <span class="fa fa-plus"></span>
                                                </button>
                                                </div>
                                            </td>
    
                                            <td style="width:15%">
                                                <input type="text" name='hsn[]' id="hsn" class="form-control  HSNCODE" style="color: black; background-color: white ;" readonly />
                                            </td>
    
                                            <td style="width:13%">
                                                <input type="number" name='qty[]' id="qty"  class="form-control  qty mb-1" step=0 min=0 style="color: black; background-color: white ;" value=0  required />
                                            </td>
                                        
                                            <td style="width:12%">
                                                <input type="number" name='price[]' id="unit" class="form-control  price" step="0.00" min="0" style="color: black; background-color: white ;" value=0 readonly />
                                            </td>
                                            <td style="width:12%">
                                                <input type="text" name='vat[]' id="Vat" class="form-control  seltax"  step="0.00" min="0" style="color: black; background-color: white ;" value=0 readonly />
                                            </td>
                                           
    
                                            <td style="width: 10%;">
                                                <input type="number" name='discount[]'  placeholder='Enter Discount' id="disc" value=0 class="form-control  disc" step=0 min=0 style="  color: black; background-color:white;"  />
                                            </td>
                        
                                            <td style="width:13%">
                                                <input type="number" name='total[]' id="total" class="form-control  total" value=0 readonly style="color: black; background-color:white;"  />
                                            </td>
                                            <td hidden><input disabled type="number"  id="taxamount" class="taxamount" value=0 /></td>
                                            
                                            <td style="width:5%">
                                                
                                                <button type="button" id="1" class="btn button_border  remove_row px-2 py-1 mx-1 fa fa-close" title="Remove Row"> Delete</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                  
                                </table>
                                <a class="btn  ml-1" role="button" id="add" style="border-color: #68020F;" ><span class="fa fa-plus"></span></a>
                            </div>
                        </div>

                    </div>
                    <div class="inn" id="inn" hidden>
                        <div class="row clearfix">
                            <div class="col-md-12 table-responsive-md mt-3" >
                                <div id="activityBox">

                                </div>
                                
                               
                            </div>
                        </div>
                    </div>
                    
                    

                    <div class="clearfix" style="margin-top:10px" id="cal1">
                        <div class="row" style="margin-left: 2vh;" >
                            <div class="col-md-5 table-responsive-md mt-3 " id="tab_logic_total" style=" color: black; border: 1px solid #68020F ; margin-left: -2vh;background-color: #68020F;" >
                                <div class="p-3">
                                    <div class="row container-fluid p-2 m-0">
                                        <div class="col-sm-4 mt-2"><label class="text-center" style="color: #ffffff;">Sub Total</label></div>
                                        <div class="col-sm-1 mt-2" style="color: #ffffff;">:</div>
                                        <div class="col-sm-7">
                                            <input type="number" step="any" name='subtotal' value=0.00 readonly style="color: rgb(4, 4, 4);border-color: #ffffff !important;background-color: #ffffff;" class="form-control " id="sub_total">
                                        </div>
                                        <div class="col-sm-4 m-0 p-0"></div>
                                    </div>

                               

                                    <div class="row container-fluid p-2 m-0">
                                        <div class="col-sm-4 mt-2"><label for="a" class="text-center" style="color: #ffffff;">VAT Amount</label></div>
                                        <div class="col-sm-1 mt-2" style="color: #ffffff;">:</div>
                                        <div class="col-sm-7">
                                        <input type="text" step="any" name='disvatper' id="tax_amount" value=0.00 style="color: rgb(0, 0, 0);border-color: #ffffff !important;background-color: #ffffff;" class="form-control tax_amount"/>
                                        </div>
                                        <div class="col-sm-4 m-0 p-0"></div>
                                    </div>

                                    <div class="row container-fluid p-2 m-0">
                                        <div class="col-sm-4 mt-2"><label for="a" class="text-center" style="color: #ffffff;">Adjustment</label></div>
                                        <div class="col-sm-1 mt-2" style="color: #ffffff;">:</div>
                                        <div class="col-sm-7">
                                        <input type="number" step="any" name='adjustment' id="adj" value=0.00 class="form-control " style="color: rgb(0, 0, 0);border-color: #ffffff !important;background-color: #ffffff;"/>
                                        </div>
                                        <div class="col-sm-4 m-0 p-0"></div>
                                    </div>
                                    
                                    <div class="row container-fluid p-2 m-0">
                                        <div class="col-sm-4 mt-2"><label for="a" class="text-center" style="color: #ffffff;">Grand Total</label></div>
                                        <div class="col-sm-1 mt-2" style="color: #ffffff;">:</div>
                                        <div class="col-sm-7">
                                        <input type="text" name='grandtotal' id="grandtotal" value=0.00  style="color: rgb(0, 0, 0);border-color: #ffffff !important;background-color: #ffffff;" class="form-control "/>
                                        </div>
                                        <div class="col-sm-4 m-0 p-0"></div>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
            
                    <div class="col-md-12 d-flex mt-3">

                        <button type="submit" class="btn button_border me-3" name="save_new" style="background-color:#68020F;color: #ffffff;">SAVE & NEW</button>
                        <button type="submit" id="save-button" class="btn button_border me-3" style="background-color:#68020F;color: #ffffff;">SAVE</button>

                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
</div>
</div> 
                    
                    
                  
                </form>
                <div class="modal fade" id="unitModal" tabindex="-1" aria-labelledby="exampleModalLabel"aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel"
                                    style="color: #68020F; font-weight: 900;">ADD PARTY</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="container">
                                <div class="modal-body mb-1 pb-1">
                                    <div class="container-fluid">
                                        <form id="unitmodalform" action="" method="post" enctype="multipart/form-data">
                                            {% csrf_token %}

                                            <div class="form-group row">
                                                <div class="col-md-4">
                                                        <label for="party_name" class="col-form-label">PARTY
                                                            NAME</label>
                                                        <input type="text" class="form-control" id="party_name"
                                                            placeholder="Party Name" name='party_name'>
                                                </div>
                                                <div class="col-md-4" style="position: relative;">
                                                        <label for="party_address"
                                                            class="col-form-label">TRN NO</label>
                                                        <input type="text" class="form-control" id="gst_no"
                                                            placeholder="TRN NO"
                                                            name='gst_no'>
                                                            <span id="gstno-validation" style="position: absolute; right: 14px; top: 8px;"></span>
                                                            <label id="trn_no_error" style="color: rgb(101, 3, 3);"></label>
                                                            <label style="color: rgb(101, 3, 3);">* 32AAQFR1222B1ZS</label>
                                                </div>
                                                <div class="col-md-4" style="position: relative;">
                                                        <label for="party_name" class="col-form-label">MOBILE</label>
                                                        <input type="text" class="form-control" id="party_num"
                                                            placeholder="Phone Number" oninput="validatePhoneNumber(this)"
                                                             name='party_num' required>
                                                        <span id="contact-validation" style="position: absolute; right: 15px; top: 8px;"></span>
                                                        

                                                </div>
                                            </div>
                                            <div class="tabContainer">
                                                <ul class="nav nav-pills nav-fill mt-3" id="myTabs" style="background-color: #FFD6D7;">
                                                    <li class="nav-item">
                                                        <button type="button" class="nav-link" id="defaultOpen"
                                                        onclick="toggleSection('GST')">VAT & Address</button>
    
                                                    </li>
                                                    <li class="nav-item">
                                                        <button type="button" class="nav-link" id="creditTab"
                                                        onclick="toggleSection('Credit')">Credit & Balances</button>
    
                                                    </li>
                                                    <li class="nav-item">
                                                        <button type="button" class="nav-link" id="balancesTab"
                                                        onclick="toggleSection('additionalfield')">Additional Field</button>
                                                    </li>
                                            </ul>
                                                <div id="transactionForm" class="tab-pane p-3" style="margin-top: 3%;">
                                                    <div class="form-group row">
                                                        <div class="col-md-6">
                                                            <div>
                                                                <label for="state" class="col-form-label">TRN Type</label>

                                                                <select class="form-control" name="gsttype" id="gsttype">
                                                                    <option selected hidden value="">Select TRN Type</option>
                                                                    <option value="Registered Business - Regular"> Registered Business - Regular </option>
                                                                    <option value="Registered Business - Composition"> Registered Business - Composition </option>
                                                                    <option value="Unregistered/Consumers"> Unregistered/Consumers</option>
                                                                </select>
                                                            </div><br>
                                                            <div>
                                                                <label for="state" class="col-form-label">Supply State</label>
                                                                <input type="text" class="form-control" id="supp_state"
                                                                    placeholder="State"
                                                                    name='supp_state'>
                                                            </div><br>
                                                            <div>
                                                                <label for="email" class="col-form-label">Email</label>
                                                                <input type="email" class="form-control" id="email"
                                                                    placeholder="Email"
                                                                    name='email' oninput="validateEmail(this)" required>
                                                                <span id="email-validation" style="position: absolute; right: 15px; top: 8px;"></span>
                                                            </div>

                                                        </div>
                                                        <div class="col-md-6">
                                                            <div>
                                                                <label for="address" class="col-form-label">Billing Address</label>
                                                                <textarea class="form-control" id="party_addr" placeholder="Enter Party Address"
                                                                    rows="6" name="party_addr"></textarea>
                                                            </div>
                                                        </div>
                                                    </div>    
                                                    <div class="col-md-12 d-flex justify-content-start mt-5">
                                                        <button type="button" class="btn button_border me-3 next-btn" onclick="showPanel(1)">NEXT</button>
                                                    </div>
                                                </div>

                                                <div id="creditForm" class="tab-pane p-3" style="margin-top: 3%;">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <Label for="bal" class="col-form-label">Opening Balance</label>
                                                                <input type="number" class="form-control" id="creditamt"
                                                                placeholder="Opening Balance"name='creditamt'>
                                                        </div>
                                                        <!-- <div class="col-md-6">
                                                            <label for="creditLimit" class="col-form-label">Credit Limit</label>
                                                            <input type="number" class="form-control" id="crLimit"
                                                                placeholder=""
                                                                name='crLimit'>
                                                        </div> -->
                                                    </div><br>
                                                    <div class="row">
                                                        <div class="col-md-4 mt-2">
                                                            <input type="radio" name="paymentType" value="To Receive" id="toReceiveRadio">
                                                                To Receive
                                                        </div>
                                                        <div class="col-md-4 mt-2">
                                                            <input type="radio" name="paymentType" value="To Pay" id="toPayRadio">
                                                                To Pay
                                                        </div>
                                                    </div><br>
                                                
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <label for="date" class="col-form-label">Date</label>
                                                            <input type="date" class="form-control" id="credit_date"
                                                                placeholder=""
                                                                name='credit_date' value="{% now 'Y-m-d' %}">
                                                        </div>
                                                    </div><br>
                                                    <div class="col-md-12 d-flex justify-content-start mt-3">

                                                        <button type="button" class="btn button_border me-3 prev-btn" onclick="showPanel(0)">PREVIOUS</button>
                                                        <button type="button" class="btn button_border me-3 next-btn" onclick="showPanel(2)">NEXT</button>

                                                    </div>
                                                </div>

                                                <div id="balancesForm" class="tab-pane p-3" style="margin-top: 3%;">
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <label for="add1" class="col-form-label">Additional Field1</label>
                                                            <input type="text" class="form-control" id="addField1"
                                                                placeholder=""
                                                                name='addField1'>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="add2" class="col-form-label">Additional Field2</label>
                                                            <input type="text" class="form-control" id="addField2"
                                                                placeholder=""
                                                                name='addField2'>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="add3" class="col-form-label">Additional Field3</label>
                                                            <input type="text" class="form-control" id="addField3"
                                                                placeholder=""
                                                                name='addField3'>
                                                        </div>
                                                        {% if error_message and "TRN number already exists!!!" in error_message %}
                                                            <script>
                                                                alert("Error: TRN number already exists!!!");
                                                            </script>
                                                        {% elif error_message and "TRN number required."}
                                                        <script>
                                                            alert("Error: TRN number required!!!");
                                                        </script>
                                                        {% elif error_message and "Email already exists!!!" in error_message %}
                                                            <script>
                                                                alert("Error: Email already exists!!!");
                                                            </script>
                                                        {% endif %}
                                                        <div class="col-md-12 d-flex justify-content-start mt-5">

                                                            <button type="button" class="btn button_border me-3 prev-btn" onclick="showPanel(1)">PREVIOUS</button>
                                                            <button type="button" class="btn button_border me-3" data-dismiss="modal" id="saveparty">SAVE</button>
    
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="itModal" tabindex="-1" aria-labelledby="exampleModalLabel2"
                    aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel"
                                    style="color: #68020F; font-weight: 900;">ADD ITEM</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="container">
                                <div class="modal-body mb-1 pb-1">
                                    <div class="container-fluid">
                                        <form id="itmodalform" action="" enctype="multipart/form-data" method="post">
                                            {% csrf_token %}
                                            <div class="p-3" style="background-color: white; border-radius: 2.5vh;border:2px solid #68020F" >
                                            <div class="form-group row">
                                                <div class="d-flex">
                                                    <div class="pt-3 w-50">
                                                      <input type="text" name="itm_type" id="itm_type" hidden>
                                                      <label style="user-select: none;" class="fs-4 tb" for="goods">Goods</label>
                                                      <input id="goods" class="me-3 " type="radio" name="item_ty" required>
                                                      <label style="user-select: none;" class="fs-4 tb" for="service">Services</label>
                                                      <input id="service" type="radio" name="item_ty" required>
                                                    </div>
                                                    <div class="mb-3 w-50">
                                                      <label class="fw-bold tb fs-3" for="">NAME</label><br>
                                                      <input style="color: black;" class="form-control mt-2 input_border text-black" type="text" placeholder="Enter Item Name" autocomplete="off" name="name" id="name">
                                                    </div>
                                                  </div>
                                                <div class="col-md-6">
                                                    <label for="item_hsn" class="col-form-label">ITEM HSN</label>
                                                    <input type="number" class="form-control" id="item_hsn" name='item_hsn' onchange="checkhsn(this)">
                                                    <span id="hsn-validation" style="position: absolute; right: 14px; top: 8px;"></span>
                                                    <div class="text-danger m-2" id="warnhsn"></div>
                                                    <label id="hsnerror" style="color: rgb(101, 3, 3);"></label>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="col-form-label" for="item_unit">UNIT</label>
                                                    <div style="display: flex;">
                                                        <div class="myDropDown">
                                                            <select class="form-control" id="item_unit" name="item_unit">
                                                                <option value="" selected disabled>Select an option</option>
                                                                <option value="Numbers">Numbers</option>
                                                                <option value="Packages">Packages</option>
                                                                <option value="Box">Box</option>
                                                                {% for i in unit %}
                                                                <option value="{{ i.unit_name }}">{{ i.unit_name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="btn-group" role="group" aria-label="Third group" style="margin-left: 5px;">
                                                            <button type="button" class="btn button_border" data-bs-toggle="modal" data-bs-target="#unitsModal" data-bs-whatever="@mdo">
                                                            <span class="fa fa-plus" ></span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>
                                            <br><br>
                                            <div class="row">
                                                <div  class="col-sm-12 col-md-1"></div>
                                                <div class="col-sm-12 col-md-5 pb-4">
                                                  <div class="me-3 text-center">
                                                    <h3><strong class="fw-bolder" style="color: #68020F;">PRICING</strong></h3>
                                                  </div>
                                                  <div class="p-3" style="background-color: white; border-radius: 2.5vh;border:2px solid #68020F" >
                                                        <div class="col-md-12">
                                                            <div class="pt-1 mt-3" >
                                                                <input type="text" name="taxable_result" id="taxable_result" hidden>
                                                                <label style="user-select: none;" class="fs-4 tb" for="item_tax_1">Tax</label> &nbsp;
                                                                <input id="item_tax_1" class="me-3" type="radio" name="item_tax_result" required>
                                                                <label style="user-select: none;" class="fs-4 tb" for="item_tax_2">Tax Excempted</label>&nbsp;
                                                                <input id="item_tax_2" type="radio" name="item_tax_result" required>
                                                              </div>
                                          
                                                              <div id="vatdiv" class="mb-3 pt-3" hidden>
                                                                  <label class="fw-bold tb fs-3" for="">VAT</label><br>
                                                                  <input type="text" class="form-control mt-1 input_border text-black" name="vat" id="vat">
                                                              </div>
                                                        </div><br>  
                                                    
                                                    <div class="taxable-fields">
                                                    <div class="form-group row ">    
                                                        <div class="col-md-12 mb-3">
                                                            <div>
                                                                <label for="saleprice" class="col-form-label">SALES PRICE</label>
                                                                <input type="number" class="form-control" id="item_slprice" name='item_slprice'>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-12 mb-3">
                                                            <div>
                                                                <label for="purchase" class="col-form-label">PURCHASE PRICE</label>
                                                                <input type="number" class="form-control" id="item_prprice" name='item_prprice'>
                                                            </div>
                                                        </div>
                                                    </div>    
                                                    </div>
                                                </div>
                                                </div>

                                                <div class="col-sm-12 col-md-5 pb-4">
                                                    <div class="me-3 text-center">
                                                      <h3><strong class="fw-bolder" style="color: #68020F;">STOCKS</strong></h3>
                                                    </div>
                                                    <div class="p-3" style="background-color: white; border-radius: 2.5vh;border:2px solid #68020F" >
                                                    <div class="form-group row">    
                                                        <div class="col-md-12">
                                                            <div>
                                                                <label for="opstock" class="col-form-label">OPENING STOCK</label>
                                                                <input type="number" class="form-control" id="item_opstock" name='item_opstock' value="0">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-12">
                                                            <div>
                                                                <label for="atprice" class="col-form-label">AT PRICE</label>
                                                                <input type="number" class="form-control" id="item_atprice" name='item_atprice' value="0">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-group row mt-3">    
                                                        <div class="col-md-12">
                                                            <div>
                                                                <label for="stdate" class="col-form-label">DATE</label>
                                                                <input type="date" class="form-control" id="item_stdate" name='item_stdate' value="{% now 'Y-m-d' %}">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                    
                                                    
                                                </div>

                                            
                                            </div>
                                         

                                               
                                                <button type="button" class="btn button_border me-3" data-dismiss="modal" id="itemSave">SAVE</button>

                                            
                                        </form>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div> 
                  
                </div>
                <div class="modal fade" id="unitsModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h1 class="modal-title fs-5" id="exampleModalLabel" style="color: #68020F; font-weight: 900;">ADD UNIT</h1>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body mb-1 pb-1">
                          <form class="mb-0" id="unitsModal">
                            <div class="mb-3">
                              <label for="unit_name" class="col-form-label">UNIT</label>
                              <input type="text" class="form-control _border" id="unit_name" placeholder="Enter Unit" style="border: 2px solid #68020F;" name='unit_name'>
                            </div>
                            <div class="m-0 text-center">
                              <label for="message-text" class="col-form-label  text-danger fw-lighter">Example : PCS/BOX/LITER</label>
                            </div>
                          </form>
                        </div>
                        <div class="modal-footer d-flex justify-content-center mt-1">
                          <button type="button" class="btn ps-5 pe-5 button_border" data-bs-dismiss="modal">Close</button>
                          <button type="button" class="btn ps-5 pe-5 button_border" id="unitmodalsubmit">ADD</button>
                        </div>
                      </div>
                    </div>
                       
                    </script>
                </div>
            </div>

        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>
<script>

function changeprd11(a, b) {
    var selectedvalue = a.value;
    console.log(selectedvalue, 'hihi');
    
    // Add an alert message
    alert('Are you ready to change invoice item!');

    $.ajax({
        url: "{% url 'itemdetails' %}",
        type: 'GET',
        data: {
            id: selectedvalue,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            data = response.hsn;
            data3 = response.price;
            data4 = response.vat;
            data5 = response.qty;
            console.log(data5);

            document.getElementById(`hsn${b}`).value = data;
            document.getElementById(`unit${b}`).value = data3;
            document.getElementById(`Vat${b}`).value = data4;
            document.getElementById(`qty${b}`).value = data5;

            // Optionally, call calc1() here if it's dependent on the response data
        },
        // Optionally, add error handling here
    });
    calc1();
    // Optionally, call calc1() here if it's not dependent on the response data
}

    function changeprd12(d){
        const itemselect = document.querySelector(`.itemselect3${d}`)
        const selectedOption =itemselect.options[itemselect.selectedIndex]
        const selectedvalue = selectedOption.value
        console.log(selectedvalue)
        document.getElementById(`qty${d}`).value = 0
        document.getElementById(`total${d}`).value = 0
        document.getElementById(`Vat${d}`).value = 0
        document.getElementById(`disc${d}`).value = 0
        document.getElementById(`taxamount${d}`).value = 0

       
        $.ajax({
            url: "{% url 'itemdetails' %}",
            type : 'GET',
            data:{
                id : selectedvalue,
                csrfmiddlewaretoken: '{{ csrf_token }}'
                },
            
            success: function(response) {
                data = response.hsn
                data3 = response.price
                data4 = response.vat
                
                
                document.getElementById(`hsn${d}`).value = data;
                document.getElementById(`unit${d}`).value = data3;
                document.getElementById(`Vat${d}`).value = data4;
                

                
                
            },
        
        });
        calc1();
    }
</script>
<script>
    
    $('#add1').click(function(){
            var lastRowId = $('#items-table-body1  tr:last').data('rowno');
            console.log(lastRowId)
          

            // Increment the numeric part by one
           
            var roinc=lastRowId;
            // var roinc = $("#items-table-body tr").length;
            
            
            roinc++
            
            $('#items-table-body1').append(
                `<tr id='addrr0${roinc}' data-rowno=${roinc}>
                    <td class = 'nnum' style="text-align: center; width:2%"">${roinc}</td>
                    <td style="width:18%">
                        <div class="d-flex">
                            <select name='product[]' id="product${roinc}" data-rowno=${roinc} class="form-control button_border product1 select2 itemselect3${roinc}"  onchange="changeprd12(${roinc})" style="color: black; background-color: white;">
                                <option value="" selected hidden>Select Product</option>
                                {% for i in item %}
                                    {% if i.cid_id == cmp.cid %}
                                        <option value="{{ i.id }}" >{{ i.itm_name  }} </option>
                                    {% endif %}
                                {% endfor %}
                            </select>&nbsp;&nbsp;&nbsp;
                            <button type="button" class="btn button_border" id="itmodalBtn" data-bs-toggle="modal"
                    data-bs-target="#itModal" data-bs-whatever="@mdo">
                    <span class="fa fa-plus"></span>
                </button>
                    
                            
                            
                        </div>
                    </td>

                    <td tyle="width:15%">
                        <input type="text" name='hsn[]' id="hsn${roinc}" class="form-control button_border px-1" style="color: black; background-color: white;" readonly />
                    </td>

                    <td style="width:10%">
                        <input type="number" name='qty[]' value=0 id="qty${roinc}" class="form-control button_border qty mb-1" step=0 min=0 style="color: black; background-color: white;" />
                    </td>

                    <td tyle="width:12%">
                        <input type="number" name='price[]' id="unit${roinc}" value=0 class="form-control button_border price" step="0.00" min="0" style="color: black; background-color: white;" readonly/>
                    </td>

                    <td tyle="width:12%">
                        <input type="text" name='vat[]' id="Vat${roinc}" value=0 class="form-control button_border seltax" value="{{0}}" step="0.00" min="0" style="color: black; background-color: white;" readonly/>
                    </td>  

                    <td tyle="width:8%">
                        <input type="number" name='discount[]' placeholder='Enter Discount' value=0 id="disc${roinc}" class="form-control button_border disc" step=0 min=0 style="color: black; background-color: white;">
                    </td>

                    <td style="width:10%">
                        <input type="number" name='total[]' id="total${roinc}" placeholder=0 class="form-control button_border total" value=0 step="any" style="color: black; background-color: white;" readonly />
                    </td>

                    <td hidden><input type="number" step="any" name='taxamount1' id="taxamount${roinc}" class=" taxamount" /></td>
                    
                    <td style="width:10%">
                        <button type="button" id="${roinc}" class="btn button_border px-2 mx-1 py-1 remove_row1 fa fa-close">Delete</button>
                    </td>
                </tr>`
            );
            $(`.itemselect3${roinc}`).select2()
            reloadItem1();
            $('#tab_logic1').on('change', '.qty, .hsn', function() {
    validateRows1();
});
function validateRows1() {
    var isValid = true;
   
    return isValid;
}

            var table = document.getElementById('tab_logic1');
            var rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                for (var i = 0; i < rows.length; i++) {
                    var cells = rows[i].getElementsByTagName('td');
                    cells[0].innerText = i + 1;
                    
                }
           
               
        
            });
            $(document).on('change', '.product1',function(){ 
                var n = $(this).data("rowno");
                console.log(n,'jhgjhg')
                $.ajax({
                    url: "{% url 'itemdetails' %}",
                    type : 'GET',
                    data:{
                        id : $(this).val(),
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                    
                    success: function(response) {
                        data = response.hsn
                        data3 = response.price
                        data4 = response.vat
                        data5 = response.qty
                        
                        
                        document.getElementById('hsn'+n).value = data;
                        document.getElementById('unit'+n).value = data3;
                        document.getElementById('Vat'+n).value = data4;
                        document.getElementById('qty'+n).value = data5;
                        
        
                        
                        
                    },
                    
                });
                calc1();
            });
            function reloadItem1() {
        $.ajax({
            url: "{% url 'item_dropdown' %}",
            type: "GET",
            dataType: "json",
            data: $(this).serialize(),
            csrfmiddlewaretoken: '{{ csrf_token }}',

            success: function(data) {
                $('#tab_logic1 tbody tr').each(function(){
                    var row = $(this);
                    var drop = row.find('.product1');
                    var existingVal = drop.val();
                    drop.empty();
                    console.log(row,'sdsg')
                    // dropdown.append(`<option ${selectedValue} selected hidden>${selectedText}</option>`);
                    var defaultOption = new Option("Select Item", "", true, true);
        defaultOption.disabled = true;
        drop.append(defaultOption);
                    $.each(data, function(key, value) {
                        // dropdown.append($('<option></option>').attr('value', key).text(value).val(key));
                        console.log(value);
                        var newOption = new Option(value[1], value[0], false, false);
                        console.log('appended',value[0]);
                        drop.append(newOption);
                        console.log('done...');
                    });

                    if(existingVal != ""){
                        drop.val(existingVal);
                    }
                })
                
            },
            error: function(xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
    }
        
        
            $(document).on('click','.remove_row1',function(){
                var row_id = $(this).attr("id");
                // $('#addr0'+row_id+'').css('display','none');
                $('#addrr0'+row_id+'').remove();
                var table = document.getElementById('tab_logic1');
                var rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                for (var i = 0; i < rows.length; i++) {
                    var cells = rows[i].getElementsByTagName('td');
                    cells[0].innerText = i + 1;
                    
                }
                calc1();
            });
           
        
            $(document).ready(function(){
                $('#items-table-body1').on('keyup change', function () {
                    calc1();
                });
        
                
            });
            function calc1() {
        $('#tab_logic1 tbody tr').each(function () {
            var html = $(this).html();
            if (html != '') {
                var qty = $(this).find('.qty').val();
                var price = $(this).find('.price').val();
                var dis = $(this).find('.disc').val();
                var taxString = $(this).find('.seltax').val(); // Get the value from the input field
                var tax = parseInt(taxString.replace(/\D/g, ''), 10); // Extract integer part using regular expression

                console.log(taxString)
                console.log(tax)
               
       
                $(this).find('.total').val((parseFloat(qty) *parseFloat(price))-parseFloat(dis));
                $(this).find('.taxamount').val(((qty * price)-dis) * (tax / 100));
                
                calc_total();
            }
        });
    }

    function calc_total() {
        total = 0;
        $('.total').each(function () {
            total += parseFloat($(this).val());
        });
        taxamount = 0;
        $('.taxamount').each(function () {
            taxamount += parseFloat($(this).val());
        });
        $('#sub_total').val(total.toFixed(2));
        $('#tax_amount').val(taxamount.toFixed(2));
        adj_val = parseFloat($('#adj').val())
        gtot = taxamount + total + adj_val;
        $('#grandtotal').val(gtot.toFixed(2));
        $('#baldue').val(gtot.toFixed(2));
        adv_val = parseFloat($('#advance').val())
        adv_val = gtot - adv_val
        $('#balance').val(adv_val.toFixed(2));
       

    }

        

    $(document).on("change", "#adj", function(){
        var subtot = $('#sub_total').val();
        var tax = $('#tax_amount').val();
        var adj = $("#adj").val();
        var adv = $("#advance").val();
        $('#grandtotal').val((parseFloat(subtot)+parseFloat(tax)+parseFloat(adj)).toFixed(2));
        $('#balance').val((parseFloat(subtot)+parseFloat(tax)+parseFloat(adj)-parseFloat(adv)).toFixed(2));
    });
</script>
<script>
    $(document).ready(function() {
        $("#advance").change(function() {
            tot_val = parseFloat($('#grandtotal').val())
            adv_val = parseFloat($('#advance').val())
            if (tot_val<adv_val){
                $('#advance').val(0)
                $('#balance').val(tot_val.toFixed(2));
                alert("Advance Greater than Total Amount")
            }else{
                tot_val = tot_val - adv_val
                $('#balance').val(tot_val.toFixed(2));
            }
        })
    })
    function reloadItem() {
        $.ajax({
            url: "{% url 'item_dropdown' %}",
            type: "GET",
            dataType: "json",
            data: $(this).serialize(),
            csrfmiddlewaretoken: '{{ csrf_token }}',

            success: function(data) {
                $('#tab_logic tbody tr').each(function(){
                    var row = $(this);
                    var drop = row.find('.product');
                    var existingVal = drop.val();
                    drop.empty();
                    console.log(row,'sdsg')
                    // dropdown.append(`<option ${selectedValue} selected hidden>${selectedText}</option>`);
                    var defaultOption = new Option("Select Item", "", true, true);
        defaultOption.disabled = true;
        drop.append(defaultOption);
                    $.each(data, function(key, value) {
                        // dropdown.append($('<option></option>').attr('value', key).text(value).val(key));
                        console.log(value);
                        var newOption = new Option(value[1], value[0], false, false);
                        console.log('appended',value[0]);
                        drop.append(newOption);
                        console.log('done...');
                    });

                    if(existingVal != ""){
                        drop.val(existingVal);
                    }
                })
                
            },
            error: function(xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
    }


$(document).ready(function(){
    var roinc = 1
    
    $('#add').click(function(){
        var roinc1 = $("#items-table-body tr").length;
        roinc++
        roinc1++
        $('#items-table-body').append(
            `<tr id='addr0${roinc}'>
                <td class = 'nnum  rowinc' style="text-align: center; width:2%"">${roinc1}</td>

                <td style="width:18%">
                    <div class="d-flex">
                        <select name='product[]' id="product${roinc}" class="form-control  product select2 itemselect2${roinc}"  onchange="changeprd(${roinc})" style="color: black; background-color: white;">
                            <option value="" selected hidden>Select Product</option>
                            {% for i in item %}
                                {% if i.cid_id == cmp.cid %}
                                    <option value="{{ i.id }}" >{{ i.itm_name  }} </option>
                                {% endif %}
                            {% endfor %}
                        </select>&nbsp;&nbsp;&nbsp;

                        <button type="button" class="btn button_border" id="itmodalBtn" data-bs-toggle="modal"
                                                    data-bs-target="#itModal" data-bs-whatever="@mdo">
                                                    <span class="fa fa-plus"></span>
                                                </button>
                    </div>
                </td>

                <td tyle="width:15%">
                    <input type="text" name='hsn[]' id="hsn${roinc}" class="form-control  px-1 hsn" style="color: black; background-color: white;" readonly />
                </td>

                <td style="width:10%">
                    <input type="number" name='qty[]' value=0 id="qty${roinc}" class="form-control  qty mb-1" step=0 min=0 style="color: black; background-color: white;" required />
                </td>

                <td tyle="width:12%">
                    <input type="number" name='price[]' id="unit${roinc}" value=0 class="form-control  price" step="0.00" min="0" style="color: black; background-color: white;" readonly/>
                </td>

                <td tyle="width:12%">
                    <input type="text" name='vat[]' id="Vat${roinc}" value=0 class="form-control  seltax" value="{{0}}" step="0.00" min="0" style="color: black; background-color:white;" readonly/>
                </td>  

                <td tyle="width:8%">
                    <input type="number" name='discount[]' placeholder='Enter Discount' value=0 id="disc${roinc}" class="form-control  disc" step=0 min=0 style="color: black; background-color: white;">
                </td>

                <td style="width:10%">
                    <input type="number" name='total[]' id="total${roinc}" placeholder=0 class="form-control  total" value=0 step="any" style="color: black; background-color:white;" readonly />
                </td>

                <td hidden><input disabled type="number" step="any"  id="taxamount${roinc}" class=" taxamount" /></td>
                
                <td style="width:10%">
                    <button type="button" id="${roinc}" class="btn button_border  px-2 mx-1 py-1 remove_row fa fa-close">Delete</button>
                </td>
            </tr>`
        );
        $(`.itemselect2${roinc}`).select2()
        reloadItem();

    });
    $('#tab_logic').on('change', '.qty, .hsn', function() {
    validateRows();
});

// Function to validate rows
function validateRows() {
     var partystatus = document.querySelector('input[name="partyStatusGroup"]:checked');
        console.log("partystatus:", partystatus);

        if (!partystatus) {
            alert('Please select Party Status');
            return false;
        }

        var partystatusId = partystatus.id;
        console.log("partystatus id is:", partystatusId);

        if (partystatusId === "partyonRadio") {
            var party = document.getElementById('party_details');
            if (!party.value || party.value.trim() === '' || party.value === 'Select a party name') {
                alert('Please select Party');
                return false;
            }
        }
    var isValid = true;
    if ($('#items').is(':hidden')) {
        $('#tab_logic1 tbody tr').each(function(index) {
        var product = $(this).find('.hsn').val();
        
        var qty = $(this).find('.qty').val();
        if (product === '') {
            alert('Select a product on row ' + (index + 1));
            isValid = false;
            return false;
        }
        if (qty === '' || qty === '0') {
            alert('Add quantity in row ' + (index + 1));
            isValid = false;
            return false;
        }
    });
    } else{
    $('#tab_logic tbody tr').each(function(index) {
        var product = $(this).find('.hsn').val();
        
        var qty = $(this).find('.qty').val();
        if (product === '') {
            alert('Select a product on row ' + (index + 1));
            isValid = false;
            return false;
        }
        if (qty === '' || qty === '0') {
            alert('Add quantity in row ' + (index + 1));
            isValid = false;
            return false;
        }
    });
}
    return isValid;
}

// Submit event handler for the form
$('#pbillForm').submit(function(e) {
    if (!validateRows()) {
        e.preventDefault();
    }
});
});
$(document).ready(function(){
    $('.select2').select2();
    $(document).on('change', '.itemselect2',function(){ 
        var n = $(this).attr("id").slice(7);
        console.log(n,'hhhh')
        
    });
});


    $(document).on('click','.remove_row',function(){
        var row_id = $(this).attr("id");
        $('#addr0'+row_id+'').remove();
        var table = document.getElementById('tab_logic');
        var rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (var i = 0; i < rows.length; i++) {
            var cells = rows[i].getElementsByTagName('td');
            cells[0].innerText = i+1;
        }
        calc();
        console.log()
    });
   

    $(document).ready(function(){
        $('#items-table-body').on('keyup change', function () {
            calc();
        });

        $('#tax').on('keyup change', function () {
            calc_total();
        });
    });
        
    function calc() {
        $('#tab_logic tbody tr').each(function () {
            var html = $(this).html();
            if (html != '') {
                var qty = $(this).find('.qty').val();
                var price = $(this).find('.price').val();
                var dis = $(this).find('.disc').val();
                var taxString = $(this).find('.seltax').val(); // Get the value from the input field
                var tax = parseInt(taxString.replace(/\D/g, ''), 10); // Extract integer part using regular expression

                console.log(taxString)
                console.log(tax)
               
       
                $(this).find('.total').val((parseFloat(qty) *parseFloat(price))-parseFloat(dis));
                $(this).find('.taxamount').val(((qty * price)-dis) * (tax / 100));
                
                calc_total();
            }
        });
    }

    function calc_total() {
        total = 0;
        $('.total').each(function () {
            total += parseFloat($(this).val());
        });
        taxamount = 0;
        $('.taxamount').each(function () {
            taxamount += parseFloat($(this).val());
        });
        $('#sub_total').val(total.toFixed(2));
        $('#tax_amount').val(taxamount.toFixed(2));
        adj_val = parseFloat($('#adj').val())
        gtot = taxamount + total + adj_val;
        $('#grandtotal').val(gtot.toFixed(2));
        $('#baldue').val(gtot.toFixed(2));
        adv_val = parseFloat($('#advance').val())
        adv_val = gtot - adv_val
        $('#balance').val(adv_val.toFixed(2));

    }

        

    $(document).on("change", "#adj", function(){
        var subtot = $('#sub_total').val();
        var tax = $('#tax_amount').val();
        var adj = $("#adj").val();
        var adv = $("#advance").val();
        $('#grandtotal').val((parseFloat(subtot)+parseFloat(tax)+parseFloat(adj)).toFixed(2));
        $('#balance').val((parseFloat(subtot)+parseFloat(tax)+parseFloat(adj)-parseFloat(adv)).toFixed(2));
    });
</script>
<script>
    function changeprd(d){
        const itemselect = document.querySelector(`.itemselect2${d}`)
        const selectedOption =itemselect.options[itemselect.selectedIndex]
        const selectedvalue = selectedOption.value
        console.log(selectedvalue)
        document.getElementById(`qty${d}`).value = 0
        document.getElementById(`total${d}`).value = 0
        document.getElementById(`Vat${d}`).value = 0
        document.getElementById(`disc${d}`).value = 0
        document.getElementById(`taxamount${d}`).value = 0

       
        $.ajax({
            url: "{% url 'itemdetails' %}",
            type : 'GET',
            data:{
                id : selectedvalue,
                csrfmiddlewaretoken: '{{ csrf_token }}'
                },
            
            success: function(response) {
                data = response.hsn
                data3 = response.price
                data4 = response.vat
                
                
                document.getElementById(`hsn${d}`).value = data;
                document.getElementById(`unit${d}`).value = data3;
                document.getElementById(`Vat${d}`).value = data4;
                

                
                
            },
        
        });
        calc();
    }
    function changeprd1(){
        const itemselect = document.querySelector(".itemselect")
        const selectedOption =itemselect.options[itemselect.selectedIndex]
        const selectedvalue = selectedOption.value
        console.log(selectedvalue)
        // id_val = id.slice(7)
        // console.log(id_val)
        document.getElementById('qty').value = 0
        document.getElementById('total').value = 0
        document.getElementById('Vat').value = 0
        document.getElementById('disc').value = 0
        document.getElementById('taxamount').value = 0
        $.ajax({
            url: "{% url 'itemdetails' %}",
            type : 'GET',
            data:{
                id : selectedvalue,
                csrfmiddlewaretoken: '{{ csrf_token }}'
                },
            
            success: function(response) {
                data = response.hsn
                data3 = response.price
                data4 = response.vat
                
                
                document.getElementById('hsn').value = data;
                document.getElementById('unit').value = data3;
                document.getElementById('Vat').value = data4;
                

                
                
            },
        
        });
        calc();
       
       
    }
    
    function checkhsn(element){
        var hsninput = element.value;
        var gstregexp = "[0-9]{6}";
        if (hsninput.match(gstregexp)) {
            document.getElementById('warnhsn').innerHTML = '';
        } else {
            document.getElementById('warnhsn').innerHTML = 'Please provide a valid HSN Number';
            alert('Please provide a valid HSN Number');   
        }
    }
</script>

<script>
    
    $(document).ready(function () {
        
        $('#partyonRadio').on('click',function(){
                $('#partystatus').val('partyon');
                $('.partyon').removeAttr('hidden');
        })

        $('#partyoffRadio').on('click',function(){
                $('#partystatus').val('partyoff')
                $('.partyon').attr('hidden', true);

        })
        

        $('#party_details').select2();
        $('#item_name').select2();
        $('#balance').hide();

        $(document).on("click","#saveparty",function(){
            var trnNo = $("#gst_no").val();
            var trnType=$("#gsttype").val();
            const regex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z][0-9][A-Z][A-Z0-9]$/;
            if ((trnNo.trim() === '' && trnType === 'Registered Business - Regular') || (trnNo.trim() === '' && trnType === 'Registered Business - Composition')) {
                alert('TRN No is required!');
                return; // Stop form submission if TRN is empty
            }else if (trnNo.trim() === '' && trnType === 'Unregistered/Consumers'){
                
            }
            else if (!regex.test(trnNo)){
                alert("Invalid TRN no format!!!")
                return;
            }
            var mobileNo = $("#party_num").val();
            if (mobileNo.trim() === '') {
                alert('Mobile number is required!');
                return; // Stop form submission if mobile number is empty
            } else if (!/^[0-9]{10}$/.test(mobileNo)) {
                alert('Mobile number should be a 10-digit number!');
                return; // Stop form submission if mobile number format is incorrect
            }
            var email = $("#email").val();
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (email.trim()===""){
                alert('Email ID required!')
                return;
            }else if(!emailRegex.test(email)) {
                alert('Invalid Email format!');
                return; // Stop form submission if email format is incorrect
            }
            $.ajax({
                type:"POST",
                url:"{% url 'saveParty' %}",
                data:{
                    party_name:$("#party_name").val(),
                    gst_no:$("#gst_no").val(),
                    mob:$("#party_num").val(),
                    gsttype:$("#gsttype").val(),
                    state:$("#supp_state").val(),
                    email:$("#email").val(),
                    addr:$("#party_addr").val(),
                    opbal:$("#creditamt").val(),
                    paymentType: $('input[name="paymentType"]:checked').val(),
                    date:$("#credit_date").val(),
                    add1:$("#addField1").val(),
                    add2:$("#addField2").val(),
                    add3:$("#addField3").val(),
                },
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                },
                success: function(response) {
                    if (response.success) {
                        // Party saved successfully
                        document.getElementById("unitmodalform").reset();
                        $('#unitModal').modal('hide');
                        reloadParty();
                    } else if (response.error_message) {
                        // Error occurred while saving party
                        alert(response.error_message);
                    }
                },
                error: function(xhr, status, error) {
                    // Error occurred in AJAX request
                    console.error(xhr.responseText);
                    // Handle the error gracefully if needed
                }
            });
        });

        function reloadParty(){
            $.ajax({
                url: "{% url 'party_dropdown' %}",
                type: "GET",
                dataType: "json",
                data: $(this).serialize(),
                csrfmiddlewaretoken: '{{ csrf_token }}',
                success: function(data){
                    var dropdown = $("#party_details");
                    dropdown.empty();
                    dropdown.append(`<option selected>Select Party</option>`);
                    $.each(data, function(id, name) {
                dropdown.append($('<option></option>').attr('value', id).text(name));
            });
                },
                error: function(xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        }

        
        $('#party_details').change(function() {
            $.ajax({
                url: "{% url 'get_partydetails' %}",
                data: { 
                    id: $('#party_details').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                type: 'POST',
                success: function(data) {
                    $('#balance').text("Available Balance: " + data.balance).show();
                    $('#party_phone').val(data.phone);
                    $('#address').val(data.address)
                    $('#invoiceno').html('')
                    $('#invoiceno').append($('<option>', {
                                value: '',
                                text: 'select an Invoice number',
                                hidden:true
                            }));
                    // Check if invoice number and date are available
                    if (data.invoiceno && data.invoicedate) {
                        for (var i = 0; i < data.invoiceno.length; i++) {
                            var optionText = data.invoiceno[i];
                            var optionTexts = data.invoicedate[i];
                            console.log(optionText)
                            console.log(optionTexts)
                            $('#invoiceno').append($('<option>', {
                                value: data.invoiceno[i],
                                text: optionText
                            }));
                            $('#invoicedate').append($('<option>', {
                                value: data.invoicedate[i],
                                text: optionTexts
                            }));
                        }
                        // Show salesinvoiceid div if valid data is available
                        $('#salesinvoiceid').show();
                        $('#inn').show();
                        $('.inn').removeAttr('hidden');
                        $('#cal1').attr('hidden', true);
                        $('.invoicemain').attr('hidden', true);
                        $('.product').attr('disabled', true);
                        $('.HSNCODE').attr('disabled', true);
                        $('.qty').attr('disabled', true);
                        $('.price').attr('disabled', true);
                        $('.seltax').attr('disabled', true);
                        $('.disc').attr('disabled', true);
                        $('.total').attr('disabled', true);
                        $('#sub_total').attr('disabled', true);
                        $('#tax_amount').attr('disabled', true);
                        $('#adj').attr('disabled', true);
                        $('#grandtotal').attr('disabled', true);
   
                        
                    
                    } else {
                        // Hide salesinvoiceid div if no valid data is available
                        $('#salesinvoiceid').hide();
                        $('#invoiceno').val('');
                        $('#invoicedate').val('');
                        $('.inn').attr('hidden', true);
                        $('#cal1').removeAttr('hidden');
                        $('.invoicemain').removeAttr('hidden');
                        $('.product').removeAttr('disabled');
                        $('.HSNCODE').removeAttr('disabled');
                        $('.qty').removeAttr('disabled');
                        $('.price').removeAttr('disabled');
                        $('.seltax').removeAttr('disabled');
                        $('.disc').removeAttr('disabled');
                        $('.total').removeAttr('disabled');
                        $('#sub_total').removeAttr('disabled');
                        $('#tax_amount').removeAttr('disabled');
                        $('#adj').removeAttr('disabled');
                        $('#grandtotal').removeAttr('disabled');
                        
                        
                    }
                    // $('#placesupply').val(data.placeofsupply);
                    $('#paymethod').val(data.payment);
                }
            });
           
       
        });
        $('#invoiceno').change(function() {
        var selectedInvoiceNo = $(this).val(); // Get the selected invoice number
        $.ajax({
            url: "{% url 'get_invoice_date' %}",
       // Replace "your_server_endpoint" with the actual URL to fetch the invoice date
            method: "GET", // or "POST" depending on your server endpoint
            data: { invoiceno: selectedInvoiceNo },
            success: function(response) {
                // Update the invoicedate input field with the corresponding invoice date
                $('#invoicedate').val(response.invoicedate);
                console.log(response.invoicedate)
            },
            
        });
     });
     $('#invoiceno').change(function() {
        var selectedInvoiceNo = $(this).val(); // Get the selected invoice number
        $.ajax({
            url: "{% url 'get_invoice_item' %}",
       // Replace "your_server_endpoint" with the actual URL to fetch the invoice date
            method: "GET", // or "POST" depending on your server endpoint
            data: { invoiceno: selectedInvoiceNo },
            success: function(response) {
                // Update the invoicedate input field with the corresponding invoice date
                var invoiceitem = response.items;
                $('#activityBox').html(response);
             

                
                console.log(response,"dfgdfgdfg")
            },
            
        });
     });

        function validatePhoneNumber(inputElement) {
            const phoneNumber = inputElement.value;
            const validationSpan = document.getElementById("contact-validation");

            // Regular expression to check for a 10-digit number
            const regex = /^[0-9]{10}$/;

            if (regex.test(phoneNumber)) {
                // Valid 10-digit number, display a checkmark
                validationSpan.innerHTML = "&#10004;"; // Checkmark symbol
                validationSpan.style.color = "green";
            } else {
                // Not a valid 10-digit number, display a cross mark
                validationSpan.innerHTML = "&#10060;"; // Cross mark symbol
                validationSpan.style.color = "red";
            }
        }
        
        $('#save-button').on('click', function() {
            if (!validatecreditnote()) {
                return false; // Prevent form submission if validation fails
            }
        });
        $('.add-row-button').on('click', function () {
            addNewRow();
            
        });

        $(document).on('click', '.delete-row-button', function () {
            $(this).closest('tr').remove();
            var row=$(this).closest('tr');
            calculateTotal(row);
            calculatevatperc(row);
            calculateSubtotal();
            calculateTax();
            calculateGrandtotal();
            updateTotalItems();
        });
        defaultItemOptions = $('#item_name option:not([disabled])').clone();

        function addNewRow() {
            var serialNumber = $('.table tbody tr').length + 1;

         

            $('.table tbody').append(newRow);
            $.ajax({
                url: "{% url 'get_item_dropdown' %}", // Replace this with the actual URL to fetch items
                type: "GET",
                success: function (data) {
                    var dropdown = $('#item_name_' + serialNumber);
                dropdown.empty();
                dropdown.append(`<option disabled selected>Select Item</option>`);
                $.each(data, function(key, value) {
                    dropdown.append($('<option></option>').attr('value', key).text(value[1]).val(value[0] + " " +value[2] + " " + value[3] + " " + value[4]));
                });
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                    // Handle error
                }
            });

            console.log(defaultItemOptions);
            
            $('#item_name_' + serialNumber).select2();

            updateTotalItems();
        }

        function updateTotalItems() {
            var totalItems = $('.table tbody tr').length;
            $('#total_items').val(totalItems);
        }

        function initializeSelect2ForItemName(id) {
           
            $('#item_name_' + id).select2();
            reloadItem();
        }

        $('#unitmodalBtn').on('click', function (event) {
            $('#unitModal').modal('show');
        });

        $('#itmodalBtn').on('click', function (event) {
            $('#itModal').modal('show');
        });

        $(document).on('click','#itemSave',function(){
            // event.preventDefault();
            var item_name = document.getElementById('name').value;
            var hsn = $("#item_hsn").val();
            if (hsn.length < 6) {
                alert('HSN must be at least 6 characters long');
                return; // Exit function to prevent further execution
            }
            if (item_name === '') {
                alert('Please provide an item name');
            }
            $.ajax({
                type:"POST",
                url:"{% url 'saveItem' %}",
                data:{
                    item_type: $("#itm_type").val(),
                    item_name: $("#name").val(),
                    item_hsn:$("#item_hsn").val(),
                    item_unit:$("#item_unit").val(),
                    itm_taxable:$("#taxable_result").val(),
                    itm_vat:$("#vat").val(),
                    itm_sale_price:$("#item_slprice").val(),
                    itm_purchase_price:$("#item_prprice").val(),
                    itm_stock_in_hand:$("#item_opstock").val(),
                    itm_at_price:$("#item_atprice").val(),
                    itm_date:$("#item_stdate").val()
                },
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                },
                success: function(response){
                    if (response.error_message) {
                        // Display error message
                        alert(response.error_message);
                    } else{
                        // Reset the form and hide the modal
                        document.getElementById("itmodalform").reset();
                        $('#itModal').modal('hide');
                        // Reload items if necessary
                        reloadItem();
                        reloadItem1();
                        
                    }
                },
            });
        });

       
        $(document).on('change', '[id^=item_name_]', function () {
            var rowId = $(this).attr('id').split('_')[2]; // Extract the row number from the ID

            var selectedId = $(this).val(); // Get the selected item ID
            var itemId = selectedId.split(' ')[0];
            // Make an AJAX request to fetch the item details
            $.ajax({
                url: "{% url 'fetch_item_details' %}",
                data: {
                    id: itemId,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                type: 'POST',
                success: function (data) {
                    // Update the corresponding input fields in the same row with fetched data
                    $('#hsn_' + rowId).val(data.hsn);
                    $('#price_' + rowId).val(data.price);
                    $('#tax_' + rowId).val(data.tax);
                    calculateTotal($('#hsn_' + rowId).closest('tr'));
                    calculatevatperc($('#hsn_' + rowId).closest('tr'));
                    calculateSubtotal();
                    calculateTax();
                    calculateGrandtotal();
                    // You may add more fields here if needed
                }
            });
        });

        $("#item_name").change(function(){
            var row = $(this).closest('tr');
            var selectedValue = $(this).val();
            var itemId = selectedValue.split(' ')[0];
            
            $.ajax({
                url:"{% url 'get_itemdetails' %}",
                data:{
                    id:$('#item_name').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                type:'POST',
                success: function(data) {
                    $('#hsn').val(""+data.hsn);
                    $('#price').val(""+data.price);
                    $("#tax").val(""+data.tax);
                    calculateTotal(row);
                    calculatevatperc(row);
                    calculateSubtotal();
                    calculateTax();
                    calculateGrandtotal();
                }
            });
        });
    
        $(document).on('click', '#unitmodalsubmit', function () {
            $.ajax({
                type: "POST",
                url: "{% url 'create_unit' %}",
                data: {
                    unit_name: document.getElementById('unit_name').value
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                },
                success: function (response) {
                    $("#unitsModal").hide();
                    $(".modal-backdrop").remove();
                    document.getElementById('unit_name').value = ''
                    var dropdown = $('#item_unit');
                    dropdown.append(`<option value='${response.unit_name}'>${response.unit_name}</option>`);
                    $('#itModal').modal('show');
                },
            });
        });


        $(document).ready(function(){
            $('#goods').on('click',function(){
                $('#itm_type').val('Goods')
            })
        });

        $(document).ready(function(){
            $('#service').on('click',function(){
                $('#itm_type').val('Service')
            })
        });

        $(document).ready(function(){
            $('#item_tax_1').on('click',function(){
                $('#vatdiv').attr('hidden',false)
                $('#vat').val('VAT 5%')
            });
        });

        $(document).ready(function(){
            $('#item_tax_2').on('click',function(){
                $('#vatdiv').attr('hidden',false)
                $('#vat').val('VAT 0%')
            });
        });

        $(document).ready(function(){
            $('#item_tax_1').on('click',function(){
                $('#taxable_result').val('Taxable')
            });
        });

        $(document).ready(function(){
            $('#item_tax_2').on('click',function(){
                $('#taxable_result').val('Non Taxable')
            });
        });

        function showPanel(panelIndex) {
        var tabButtons = document.querySelectorAll(".tabContainer .nav .nav-item button");
        var tabPanels = document.querySelectorAll(".tabContainer .tab-pane");

        tabPanels.forEach(function(panel) {
            panel.style.display = "none";
        });
        tabButtons.forEach(function(button) {
            button.classList.remove("active");
        });

        tabPanels[panelIndex].style.display = "block";

        tabButtons[panelIndex].classList.add("active");
        }

        $(".tabContainer .nav .nav-item button").on("click", function() {
            var tabIndex = $(this).parent().index();
            showPanel(tabIndex);
        });
        $(".next-btn").on("click", function() {
            var currentPanel = $(".tabContainer .nav .nav-item button.active").parent().index();
            showPanel(currentPanel + 1);
        });
        $(".prev-btn").on("click", function() {
            var currentPanel = $(".tabContainer .nav .nav-item button.active").parent().index();
            showPanel(currentPanel - 1);
        });

        showPanel(0);

        function showPanel2(panelIndex) {
        var tabButtons2 = document.querySelectorAll(".tabContainer2 .nav .nav-item button");
        var tabPanels2 = document.querySelectorAll(".tabContainer2 .tab-pane");

        tabPanels2.forEach(function(panel) {
            panel.style.display = "none";
        });
        tabButtons2.forEach(function(button) {
            button.classList.remove("active");
        });

        tabPanels2[panelIndex].style.display = "block";

        tabButtons2[panelIndex].classList.add("active");
        }

        $(".tabContainer2 .nav .nav-item button").on("click", function() {
            var tabIndex = $(this).parent().index();
            showPanel2(tabIndex);
        });
        $(".next-btn-2").on("click", function() {
            var currentPanel = $(".tabContainer2 .nav .nav-item button.active").parent().index();
            showPanel2(currentPanel + 1);
        });
        $(".prev-btn-2").on("click", function() {
            var currentPanel = $(".tabContainer2 .nav .nav-item button.active").parent().index();
            showPanel2(currentPanel - 1);
        });

        showPanel2(0);

        function calculateTotal(row) {
            var qty = parseFloat(row.find('.qty-input').val());
            var price = parseFloat(row.find('.price-input').val());
            var discount = parseFloat(row.find('.discount-input').val());

            var total=qty*price-discount;
            
            row.find('.total-input').val(total); 
        }

        function calculatevatperc(row){
            var total = parseFloat(row.find('.total-input').val());
            var taxamt = row.find('.tax-input').val();
            var vatRate = 0;
            if (taxamt && taxamt.includes("VAT 5%")) {
                vatRate = 0.05;
            }

            var tax = total * vatRate;
            row.find('.vatper-input').val(tax);
        }

        $(document).on('input','.qty-input, .price-input, .discount-input, .adjustment', function(){
            var row=$(this).closest('tr');
            console.log("agsjdgajs")
            calculateTotal(row);
            calculatevatperc(row);
            calculateSubtotal();
            calculateTax();
            calculateGrandtotal();
        });

        function calculateSubtotal(){
            var subtotal = 0;
            $('.table tbody tr').each(function() {
                var total = parseFloat($(this).find('.total-input').val());
                if (!isNaN(total)) {
                    subtotal += total;
                }
            });
            $('#subtotal').val(subtotal.toFixed(2)); 
        }

        function calculateTax(){
            var totalTax = 0;
            $('.table tbody tr').each(function () {
                var vatper = parseFloat($(this).find('.vatper-input').val());
                totalTax += vatper;
            });

            $('#disvatper').val(totalTax);
            $('#tax_amnt').val(totalTax.toFixed(2));
        }

        function calculateGrandtotal(){
            var grandtotal=0;
            var subtotal=parseFloat($('.subtotal').val());
            var tax_amnt=parseFloat($('.tax_amnt').val());
            var adj = parseFloat($('#adjustment').val());
            console.log("Adjustment:", adj);
            grandtotal=subtotal+tax_amnt+(adj);
            $('#grandTotal').val(grandtotal.toFixed(2))
        }    
    });
</script>
{% endblock %}